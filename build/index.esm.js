var t=function(){return t=Object.assign||function(t){for(var n,o=1,e=arguments.length;o<e;o++)for(var r in n=arguments[o])Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t},t.apply(this,arguments)};function n(t,n,o,e){return new(o||(o=Promise))(function(r,i){function a(t){try{l(e.next(t))}catch(t){i(t)}}function u(t){try{l(e.throw(t))}catch(t){i(t)}}function l(t){var n;t.done?r(t.value):(n=t.value,n instanceof o?n:new o(function(t){t(n)})).then(a,u)}l((e=e.apply(t,n||[])).next())})}function o(t,n){var o,e,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=u(0),a.throw=u(1),a.return=u(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(l){return function(u){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(o=1,e&&(r=2&u[0]?e.return:u[0]?e.throw||((r=e.return)&&r.call(e),0):e.next)&&!(r=r.call(e,u[1])).done)return r;switch(e=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,e=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=n.call(t,i)}catch(t){u=[6,t],e=0}finally{o=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,l])}}}"function"==typeof SuppressedError&&SuppressedError;var e=new Set;function r(t,r){return void 0===r&&(r={}),n(this,void 0,void 0,function(){var n,a,u,l,c,s;return o(this,function(o){switch(o.label){case 0:if(n=r.timeout,a=void 0===n?15e3:n,u=r.retries,l=void 0===u?1:u,e.has(t))return[2];c=0,o.label=1;case 1:if(!(c<=l))return[3,6];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,i(t,a)];case 3:return o.sent(),e.add(t),[2];case 4:if(s=o.sent(),c===l)throw s;return[3,5];case 5:return c++,[3,1];case 6:return[2]}})})}function i(t,n){return new Promise(function(o,e){var r=document.createElement("script");r.src=t,r.async=!0;var i=setTimeout(function(){a(),e(new Error("Timeout loading ".concat(t)))},n);function a(){clearTimeout(i),r.remove()}r.onload=function(){a(),o()},r.onerror=function(){a(),e(new Error("Failed to load ".concat(t)))},document.body.appendChild(r)})}var a=function(){function t(){this.map=new Map}return t.prototype.on=function(t,n){this.map.has(t)||this.map.set(t,new Set),this.map.get(t).add(n)},t.prototype.off=function(t,n){var o;null===(o=this.map.get(t))||void 0===o||o.delete(n)},t.prototype.emit=function(t,n){var o;null===(o=this.map.get(t))||void 0===o||o.forEach(function(t){return t(n)})},t}(),u="ROUTER:REQUEST_NAVIGATE",l="ROUTER:NAVIGATE",c="ROUTER:ON_CHANGE";function s(t,n){t.on(u,function(o){var e=o.path;n(e),t.emit(l,{path:e})})}var h=function(){function t(t){void 0===t&&(t={});var n,o,e=this;this.eventBus=new a,this.isolate=!1,this.cache={},this.stores=null!==(n=t.stores)&&void 0!==n?n:{},this.navigate=t.navigate,this.onRemoteError=t.onRemoteError,this.fallback=t.fallback,this.isolate=null!==(o=t.isolate)&&void 0!==o&&o,this.onMountStart=t.onMountStart,this.onMountEnd=t.onMountEnd,this.onUnmountStart=t.onUnmountStart,this.onUnmountEnd=t.onUnmountEnd,this.navigate&&s(this.eventBus,this.navigate),this.eventBus.on(c,function(t){var n;null===(n=e.navigate)||void 0===n||n.call(e,t)})}return t.prototype.load=function(t,e){var i,a;return n(this,void 0,void 0,function(){var n,u,l;return o(this,function(o){switch(o.label){case 0:if(this.cache[e])return[2,this.cache[e]];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,r(t,{retries:1})];case 2:return o.sent(),[3,4];case 3:throw n=o.sent(),null===(i=this.onRemoteError)||void 0===i||i.call(this,n),n;case 4:if(!(null==(u=window[e])?void 0:u.mount))throw l=new Error('Remote "'.concat(e,'" not found')),null===(a=this.onRemoteError)||void 0===a||a.call(this,l),l;return this.cache[e]=u,[2,u]}})})},t.prototype.preload=function(t,e){return n(this,void 0,void 0,function(){return o(this,function(n){switch(n.label){case 0:return[4,this.load(t,e)];case 1:return n.sent(),[2]}})})},t.prototype.mount=function(t,n,o,e){var r,i,a,u,l,c=null!==(r=null==e?void 0:e.isolate)&&void 0!==r?r:this.isolate,s=null;if(n._shadowRoot&&(n._shadowRoot.innerHTML=""),c&&"function"==typeof n.attachShadow)try{s=n.attachShadow({mode:null!==(i=null==e?void 0:e.shadowMode)&&void 0!==i?i:"open"})(n)._shadowRoot=s}catch(t){s=null}var h=document.createElement("div");s?s.appendChild(h):n.appendChild(h),n._mountEl=h;var d={name:o,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};try{null===(a=this.onMountStart)||void 0===a||a.call(this,o),t.mount(h,d),null===(u=this.onMountEnd)||void 0===u||u.call(this,o),console.log("[MFE] mounted ".concat(o," ").concat(c?"(shadow/fallback)":""))}catch(t){var f=t;console.error("[MFE] remote ".concat(o," mount failed:"),f),null===(l=this.onRemoteError)||void 0===l||l.call(this,f),this.fallback?this.fallback(h,o,f,d):h.innerHTML='<div style="color:red">Failed to load '.concat(o,"</div>")}},t.prototype.unmount=function(t,n,o){var e,r,i,a,u,l;try{null===(e=this.onUnmountStart)||void 0===e||e.call(this,null!=o?o:"");var c=null!==(r=n._mountEl)&&void 0!==r?r:this.isolate&&null!==(i=n.shadowRoot)&&void 0!==i?i:n;null===(a=t.unmount)||void 0===a||a.call(t,c),delete n._mountEl,null===(u=this.onUnmountEnd)||void 0===u||u.call(this,null!=o?o:""),o&&console.log("[MFE] unmounted ".concat(o))}catch(t){null===(l=this.onRemoteError)||void 0===l||l.call(this,t)}},t.prototype.getEventBus=function(){return this.eventBus},t.prototype.reloadRemote=function(t){var e,r,i;return n(this,void 0,void 0,function(){var n,a,u,l,c,s,h,d;return o(this,function(o){switch(o.label){case 0:n=t.name,a=t.url,u=t.global,l=t.el,c=t.isolate;try{s=window[u],h=null!==(e=l._mountEl)&&void 0!==e?e:(null!=c?c:this.isolate)&&null!==(r=l.shadowRoot)&&void 0!==r?r:l,null===(i=null==s?void 0:s.unmount)||void 0===i||i.call(s,h)}catch(t){}return delete window[u],delete this.cache[u],[4,this.load("".concat(a,"?t=").concat(Date.now()),u)];case 1:return d=o.sent(),this.mount(d,l,n,{isolate:c}),[2]}})})},t}();function d(n){var o=n,e=new Set;return{getState:function(){return o},setState:function(n){o=t(t({},o),n),e.forEach(function(t){return t(o)})},subscribe:function(t,n){return void 0===n&&(n=!0),e.add(t),n&&t(o),function(){return e.delete(t)}}}}function f(t){var n=t.eventBus,o=t.name;return{go:function(t){n.emit(u,{from:o,path:t})},onChange:function(t){return n.on(l,function(n){t(n.path)})},emitRouteChange:function(t){n.emit(c,{from:o,path:t})},onRouteChange:function(t){return n.on(c,function(n){n.from!==o&&t(n.path)})}}}export{a as EventBus,h as MFEHost,f as createSharedRouter,d as createSharedStore,s as enableRouterSync,r as loadScript};
