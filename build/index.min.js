!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).MFERuntimeZ={})}(this,function(t){"use strict";var n=function(){return n=Object.assign||function(t){for(var n,e=1,o=arguments.length;e<o;e++)for(var r in n=arguments[e])Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r]);return t},n.apply(this,arguments)};function e(t,n,e,o){return new(e||(e=Promise))(function(r,i){function a(t){try{l(o.next(t))}catch(t){i(t)}}function u(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){var n;t.done?r(t.value):(n=t.value,n instanceof e?n:new e(function(t){t(n)})).then(a,u)}l((o=o.apply(t,n||[])).next())})}function o(t,n){var e,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=u(0),a.throw=u(1),a.return=u(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(l){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(e=1,o&&(r=2&u[0]?o.return:u[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,u[1])).done)return r;switch(o=0,r&&(u=[2&u[0],r.value]),u[0]){case 0:case 1:r=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,o=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!r||u[1]>r[0]&&u[1]<r[3])){i.label=u[1];break}if(6===u[0]&&i.label<r[1]){i.label=r[1],r=u;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(u);break}r[2]&&i.ops.pop(),i.trys.pop();continue}u=n.call(t,i)}catch(t){u=[6,t],o=0}finally{e=r=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,l])}}}"function"==typeof SuppressedError&&SuppressedError;var r=new Set;function i(t,n){return void 0===n&&(n={}),e(this,void 0,void 0,function(){var e,i,u,l,c,s;return o(this,function(o){switch(o.label){case 0:if(e=n.timeout,i=void 0===e?15e3:e,u=n.retries,l=void 0===u?1:u,r.has(t))return[2];c=0,o.label=1;case 1:if(!(c<=l))return[3,6];o.label=2;case 2:return o.trys.push([2,4,,5]),[4,a(t,i)];case 3:return o.sent(),r.add(t),[2];case 4:if(s=o.sent(),c===l)throw s;return[3,5];case 5:return c++,[3,1];case 6:return[2]}})})}function a(t,n){return new Promise(function(e,o){var r=document.createElement("script");r.src=t,r.async=!0;var i=setTimeout(function(){a(),o(new Error("Timeout loading ".concat(t)))},n);function a(){clearTimeout(i),r.remove()}r.onload=function(){a(),e()},r.onerror=function(){a(),o(new Error("Failed to load ".concat(t)))},document.body.appendChild(r)})}var u=function(){function t(){this.map=new Map}return t.prototype.on=function(t,n){this.map.has(t)||this.map.set(t,new Set),this.map.get(t).add(n)},t.prototype.off=function(t,n){var e;null===(e=this.map.get(t))||void 0===e||e.delete(n)},t.prototype.emit=function(t,n){var e;null===(e=this.map.get(t))||void 0===e||e.forEach(function(t){return t(n)})},t}(),l="ROUTER:REQUEST_NAVIGATE",c="ROUTER:NAVIGATE",s="ROUTER:ON_CHANGE";function h(t,n){t.on(l,function(e){var o=e.path;n(o),t.emit(c,{path:o})})}var d=function(){function t(t){void 0===t&&(t={});var n,e,o=this;this.eventBus=new u,this.isolate=!1,this.cache={},this.stores=null!==(n=t.stores)&&void 0!==n?n:{},this.navigate=t.navigate,this.onRemoteError=t.onRemoteError,this.fallback=t.fallback,this.isolate=null!==(e=t.isolate)&&void 0!==e&&e,this.onMountStart=t.onMountStart,this.onMountEnd=t.onMountEnd,this.onUnmountStart=t.onUnmountStart,this.onUnmountEnd=t.onUnmountEnd,this.navigate&&h(this.eventBus,this.navigate),this.eventBus.on(s,function(t){var n;null===(n=o.navigate)||void 0===n||n.call(o,t)})}return t.prototype.load=function(t,n){var r,a;return e(this,void 0,void 0,function(){var e,u,l;return o(this,function(o){switch(o.label){case 0:if(this.cache[n])return[2,this.cache[n]];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,i(t,{retries:1})];case 2:return o.sent(),[3,4];case 3:throw e=o.sent(),null===(r=this.onRemoteError)||void 0===r||r.call(this,e),e;case 4:if(!(null==(u=window[n])?void 0:u.mount))throw l=new Error('Remote "'.concat(n,'" not found')),null===(a=this.onRemoteError)||void 0===a||a.call(this,l),l;return this.cache[n]=u,[2,u]}})})},t.prototype.preload=function(t,n){return e(this,void 0,void 0,function(){return o(this,function(e){switch(e.label){case 0:return[4,this.load(t,n)];case 1:return e.sent(),[2]}})})},t.prototype.mount=function(t,n,e,o){var r,i,a,u,l,c=null!==(r=null==o?void 0:o.isolate)&&void 0!==r?r:this.isolate,s=null;if(n._shadowRoot&&(n._shadowRoot.innerHTML=""),c&&"function"==typeof n.attachShadow)try{s=n.attachShadow({mode:null!==(i=null==o?void 0:o.shadowMode)&&void 0!==i?i:"open"})(n)._shadowRoot=s}catch(t){s=null}var h=document.createElement("div");s?s.appendChild(h):n.appendChild(h),n._mountEl=h;var d={name:e,stores:this.stores,eventBus:this.eventBus,host:{navigate:this.navigate}};try{null===(a=this.onMountStart)||void 0===a||a.call(this,e),t.mount(h,d),null===(u=this.onMountEnd)||void 0===u||u.call(this,e),console.log("[MFE] mounted ".concat(e," ").concat(c?"(shadow/fallback)":""))}catch(t){var f=t;console.error("[MFE] remote ".concat(e," mount failed:"),f),null===(l=this.onRemoteError)||void 0===l||l.call(this,f),this.fallback?this.fallback(h,e,f,d):h.innerHTML='<div style="color:red">Failed to load '.concat(e,"</div>")}},t.prototype.unmount=function(t,n,e){var o,r,i,a,u,l;try{null===(o=this.onUnmountStart)||void 0===o||o.call(this,null!=e?e:"");var c=null!==(r=n._mountEl)&&void 0!==r?r:this.isolate&&null!==(i=n.shadowRoot)&&void 0!==i?i:n;null===(a=t.unmount)||void 0===a||a.call(t,c),delete n._mountEl,null===(u=this.onUnmountEnd)||void 0===u||u.call(this,null!=e?e:""),e&&console.log("[MFE] unmounted ".concat(e))}catch(t){null===(l=this.onRemoteError)||void 0===l||l.call(this,t)}},t.prototype.getEventBus=function(){return this.eventBus},t.prototype.reloadRemote=function(t){var n,r,i;return e(this,void 0,void 0,function(){var e,a,u,l,c,s,h,d;return o(this,function(o){switch(o.label){case 0:e=t.name,a=t.url,u=t.global,l=t.el,c=t.isolate;try{s=window[u],h=null!==(n=l._mountEl)&&void 0!==n?n:(null!=c?c:this.isolate)&&null!==(r=l.shadowRoot)&&void 0!==r?r:l,null===(i=null==s?void 0:s.unmount)||void 0===i||i.call(s,h)}catch(t){}return delete window[u],delete this.cache[u],[4,this.load("".concat(a,"?t=").concat(Date.now()),u)];case 1:return d=o.sent(),this.mount(d,l,e,{isolate:c}),[2]}})})},t}();t.EventBus=u,t.MFEHost=d,t.createSharedRouter=function(t){var n=t.eventBus,e=t.name;return{go:function(t){n.emit(l,{from:e,path:t})},onChange:function(t){return n.on(c,function(n){t(n.path)})},emitRouteChange:function(t){n.emit(s,{from:e,path:t})},onRouteChange:function(t){return n.on(s,function(n){n.from!==e&&t(n.path)})}}},t.createSharedStore=function(t){var e=t,o=new Set;return{getState:function(){return e},setState:function(t){e=n(n({},e),t),o.forEach(function(t){return t(e)})},subscribe:function(t,n){return void 0===n&&(n=!0),o.add(t),n&&t(e),function(){return o.delete(t)}}}},t.enableRouterSync=h,t.loadScript=i,Object.defineProperty(t,"__esModule",{value:!0})});
